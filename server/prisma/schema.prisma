generator client {
  provider = "prisma-client"
  output   = "../src/lib/prisma"
}

datasource db {
  provider = "postgresql"
}


model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  name      String?
  password  String
  img       String?
  bio       String?

  posts     Post[]
  stories   Story[]

  followers Follower[] @relation("followerRelation")
  following Follower[] @relation("followingRelation")

  likes     Like[]
  comments  Comment[]

  sentMessages     Message[] @relation("sentMessages")
  receivedMessages Message[] @relation("receivedMessages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


  viewedStories Story[] @relation("StoryViews")
  storyViews    StoryView[]
  archivedStories Story[] @relation("ArchivedStories")
}

model Post {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  caption   String?
  image     String?
  video     String?
  likes     Like[]
  comments  Comment[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, postId])
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])
  text      String
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Follower {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  follower    User     @relation("followerRelation", fields: [followerId], references: [id])
  following   User     @relation("followingRelation", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String
  timestamp  DateTime @default(now())

  sender     User     @relation("sentMessages", fields: [senderId], references: [id])
  receiver   User     @relation("receivedMessages", fields: [receiverId], references: [id])
}

model Story{
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  image     String?
  video     String?
  viewedBy  User[]   @relation("StoryViews")
  views     StoryView[]
  createdAt DateTime @default(now())

  users User[] @relation("ArchivedStories")
}

model StoryView {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now())

  @@unique([userId, storyId])
}
